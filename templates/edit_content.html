{% extends "base.html" %}

{% block title %}{% if content %}编辑内容{% else %}添加内容{% endif %} - Respect and Integration{% endblock %}

{% block content %}


<!-- 引入 wangEditor 样式 -->
<link href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet">



<!-- 在<head>部分或页面末尾引入Quill的CSS和JS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<div class="edit-header">
    <h2>{% if content %}编辑内容{% else %}添加新内容{% endif %}</h2>
    <a href="/admin" class="btn secondary">返回管理页面</a>
</div>

<form method="POST" enctype="multipart/form-data" class="content-form">
    <div class="form-group">
        <label for="title">标题 *</label>
        <input type="text" id="title" name="title" required 
               value="{{ content.title if content else '' }}">
    </div>
    
    <div class="form-group">
        <label for="intro">简介 *</label>
        <textarea id="intro" name="intro" rows="3" required>{{ content.intro if content else '' }}</textarea>
        <div class="form-help">简要介绍内容，将在主页显示</div>
    </div>
    
    <div class="form-group">
        <label for="detail">详细内容 *</label>
<!--        <textarea id="detail" name="detail" rows="10" required>{{ content.detail if content else '' }}</textarea>-->
<!--        <div class="form-help">内容的完整描述，支持多行文本</div>-->

        <!--富文本编辑容器-->
        <div id="editor-container" style="border: 1px solid #ccc; border-radius: 5px;">
            {% if content and content.detail %}
            <!-- 初始化时设置编辑器内容 -->
            <div style="display: none;" id="initial-content">{{ content.detail|safe }}</div>
            {% endif %}
        </div>
        <!-- 隐藏的文本域，用于表单提交 -->
        <textarea id="detail" name="detail" style="display: none;"></textarea>
        <div class="form-help">
            使用上方工具栏编辑内容（支持加粗、列表、插入图片、表格等）
            <br>提示：图片上传后会自动插入到编辑器中
        </div>
    </div>
    
    <div class="form-group">
        <label for="image">介绍图片</label>
        <input type="file" id="image" name="image" accept="image/*">
        <div class="form-help">支持 PNG, JPG, JPEG, GIF 格式，最大 16MB</div>
        
        {% if content and content.image %}
        <div class="current-image">
            <p>当前图片:</p>
            <img src="{{ url_for('uploaded_file', filename=content.image) }}" alt="当前图片">
        </div>
        {% endif %}
    </div>

    <div class="form-group">
        <label for="sort_order">排序值</label>
        <input type="number" id="sort_order" name="sort_order"
               value="{{ content.sort_order if content else '0' }}"
               min="0" max="9999" step="1">
        <div class="form-help">数值越小越靠前，建议使用5、10、15...便于中间插入新顺序</div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn primary">
            {% if content %}更新内容{% else %}添加内容{% endif %}
        </button>
        <a href="/admin" class="btn secondary">取消</a>
    </div>
</form>


<script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js"></script>
<script>
// 初始化 wangEditor
const { createEditor, createToolbar} = window.wangEditor;


document.addEventListener('DOMContentLoaded', function() {
    // 编辑器配置
    const editorConfig = {
        placeholder: '请输入详细内容...',
        onChange(editor) {
            // 编辑器内容变化时，同步到隐藏的 textarea
            const html = editor.getHtml();
            document.getElementById('detail').value = html;
        },
        MENU_CONF: {
            uploadImage: {
                // 上传图片的配置
                server: '/api/upload_image',  // 你的上传接口
                fieldName: 'image',  // 上传文件的字段名
                maxFileSize: 10 * 1024 * 1024,  // 10M
                allowedFileTypes: ['image/*'],

                // 自定义上传参数
                meta: {
                    // 可以添加额外的参数，如 CSRF token
                },

                // 自定义插入图片
                customInsert(res, insertFn) {
                    // wangEditor 上传图片成功回调
                    if (res.errno === 0) {
                        // 从 res 中获取图片 url
                        const url = res.data.url;
                        const alt = res.data.alt || '';
                        const href = res.data.href || url;

                        // 插入图片到编辑器
                        insertFn(url, alt, href);
                    } else {
                        alert('图片上传失败: ' + (res.message || '未知错误'));
                    }
                },

                // 上传错误回调
                onError(file, err, res) {
                    console.error('上传错误:', err, res);
                    alert('图片上传失败，请重试');
                },

                // 上传超时时间
                timeout: 15 * 1000,  // 15秒
            }
        }
    };

    // 创建编辑器
    const editor = createEditor({
        selector: '#editor-container',
        html: '',
        config: editorConfig,
        mode: 'default',  // 'default' 或 'simple'
    });

    // 创建工具栏
    const toolbarConfig = {};
    const toolbar = createToolbar({
        editor,
        selector: '#editor-container',
        config: toolbarConfig,
        mode: 'default',
    });

    // 设置初始内容（如果有）
    const initialContent = document.getElementById('initial-content');
    if (initialContent) {
        editor.setHtml(initialContent.innerHTML);
        // 触发一次 onChange 事件，确保隐藏字段有值
        editor.emit('change');
    }

    // 表单提交前验证
    document.getElementById('contentForm').addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const intro = document.getElementById('intro').value.trim();
        const detail = document.getElementById('detail').value.trim();

        if (!title || !intro || !detail) {
            e.preventDefault();
            alert('请填写所有必填字段（标题、简介和详细内容）');
            return false;
        }

        // 可以在这里添加更多验证逻辑
        return true;
    });



    // HTML转义函数，防止XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }


});

</script>

<script>
// 简单的字符计数器
document.addEventListener('DOMContentLoaded', function() {
    const introTextarea = document.getElementById('intro');
    const detailTextarea = document.getElementById('detail');
    
    if (introTextarea) {
        const introCounter = document.createElement('div');
        introCounter.className = 'char-counter';
        introTextarea.parentNode.appendChild(introCounter);
        
        function updateIntroCounter() {
            introCounter.textContent = `简介长度: ${introTextarea.value.length} 字符`;
        }
        
        introTextarea.addEventListener('input', updateIntroCounter);
        updateIntroCounter();
    }
    
    if (detailTextarea) {
        const detailCounter = document.createElement('div');
        detailCounter.className = 'char-counter';
        detailTextarea.parentNode.appendChild(detailCounter);
        
        function updateDetailCounter() {
            detailCounter.textContent = `详细内容长度: ${detailTextarea.value.length} 字符`;
        }
        
        detailTextarea.addEventListener('input', updateDetailCounter);
        updateDetailCounter();
    }
});
</script>
{% endblock %}